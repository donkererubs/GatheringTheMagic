<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Who's Online + Chat + Invites</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 1em;
        }

        #container {
            display: flex;
            gap: 2rem;
        }

        section {
            border: 1px solid #ccc;
            padding: 1em;
        }

        #chatWindow {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 0.5em;
            background: #f9f9f9;
        }

        #usersList li {
            list-style: none;
            margin: 0.25em 0;
        }

            #usersList li.clickable {
                cursor: pointer;
                color: blue;
                text-decoration: underline;
            }

        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <h1>Who's Online + Chat + Invites</h1>

    <!-- Join UI -->
    <div id="joinSection">
        <input id="nameInput" placeholder="Enter your name" maxlength="20"
               title="Letters & numbers only" />
        <button id="joinBtn">Join</button>
    </div>

    <!-- Welcome -->
    <div id="welcomeSection" style="display:none; margin:1em 0;">
        <strong id="welcomeMsg"></strong>
        <button id="leaveBtn" style="margin-left:1em;">Leave Lobby</button>
    </div>

    <hr />

    <!-- Protected Panels -->
    <div id="container" class="disabled">
        <!-- Users -->
        <section style="width: 200px;">
            <h2>Users</h2>
            <ul id="usersList"></ul>
        </section>

        <!-- Chat -->
        <section style="flex: 1;">
            <h2>Chat</h2>
            <div id="chatWindow"></div>
            <div style="margin-top:0.5em;">
                <input id="chatInput" placeholder="Type a message…" style="width:80%;" />
                <button id="sendBtn">Send</button>
            </div>
        </section>
    </div>

    <!-- SignalR -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>
    <script>
        const joinSection = document.getElementById('joinSection');
        const welcomeSection = document.getElementById('welcomeSection');
        const welcomeMsg = document.getElementById('welcomeMsg');
        const leaveBtn = document.getElementById('leaveBtn');
        const nameInput = document.getElementById('nameInput');
        const joinBtn = document.getElementById('joinBtn');
        const container = document.getElementById('container');
        const usersList = document.getElementById('usersList');
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        let currentUser = null, lastUsers = [], inviteStatus = {};

        // Disable panels
        function setPanelsEnabled(on) {
            container.classList.toggle('disabled', !on);
        }
        setPanelsEnabled(false);

        // build SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl('/gameHub')
            .build();

        // 1) Render user list
        function renderUserList(users) {
            usersList.innerHTML = '';
            users.forEach(u => {
                const li = document.createElement('li');
                let text = u + (inviteStatus[u] ? ` - ${inviteStatus[u]}` : '');
                if (u === currentUser) {
                    li.innerHTML = `<strong>${text}</strong>`;
                } else if (currentUser) {
                    li.textContent = text;
                    li.classList.add('clickable');
                    li.onclick = () => sendInvite(u);
                } else {
                    li.textContent = text;
                }
                usersList.appendChild(li);
            });
        }

        // 2) Add a history message
        function appendChat(from, msg) {
            const d = document.createElement('div');
            d.textContent = `${from}: ${msg}`;
            chatWindow.appendChild(d);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // 3) Send invite
        function sendInvite(to) {
            if (to === currentUser) return;
            inviteStatus[to] = '??';
            renderUserList(lastUsers);
            connection.invoke('RequestGame', to);
        }

        // SignalR handlers
        connection.on('ReceiveUserList', users => {
            lastUsers = users.slice();
            // prune dead invites
            Object.keys(inviteStatus).forEach(u => { if (!users.includes(u)) delete inviteStatus[u]; });
            renderUserList(users);
        });

        connection.on('ReceiveMessageHistory', history => {
            chatWindow.innerHTML = '';
            history.forEach(m =>
                appendChat(m.user, m.message)
            );
        });

        connection.on('ReceiveMessage', (from, msg) => appendChat(from, msg));

        connection.on('ReceiveGameRequest', from => {
            const ok = confirm(`${from} wants to play—accept?`);
            connection.invoke('RespondGameRequest', from, ok);
        });

        connection.on('ReceiveGameResponse', (from, accepted) => {
            if (!accepted) {
                inviteStatus[from] = 'XX';
                renderUserList(lastUsers);
            }
            alert(`${from} ${accepted ? 'accepted' : 'declined'} your invite.`);
        });

        // start & auto-join if we have a stored name
        connection.start().then(() => {
            const stored = localStorage.getItem('playerName');
            if (stored) doJoin(stored);
        });

        // do the join logic
        function doJoin(name) {
            connection.invoke('Register', name).then(() => {
                currentUser = name;
                localStorage.setItem('playerName', name);
                joinSection.style.display = 'none';
                welcomeMsg.textContent = `Welcome ${name}!`;
                welcomeSection.style.display = 'block';
                setPanelsEnabled(true);
                renderUserList(lastUsers);
            });
        }

        // UI events
        joinBtn.onclick = () => {
            const name = nameInput.value.trim();
            if (!/^[A-Za-z0-9]+$/.test(name)) {
                return alert('Only letters & numbers—no spaces or special chars.');
            }
            doJoin(name);
        };

        leaveBtn.onclick = () => {
            localStorage.removeItem('playerName');
            location.reload();
        };

        sendBtn.onclick = () => {
            const txt = chatInput.value.trim();
            if (!txt) return;
            connection.invoke('SendMessage', txt).then(() => { chatInput.value = ''; });
        };
        chatInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') sendBtn.click();
        });
    </script>
</body>
</html>
