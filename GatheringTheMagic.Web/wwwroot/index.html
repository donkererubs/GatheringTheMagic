<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>GatheringTheMagic – Click Deck to Draw</title>
    <style>
            /* Reset margins/padding and force full-height */
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
            }

            body {
                display: flex;
                flex-direction: column;
                height: 100vh;
                font-family: sans-serif;
            }

            /* ------------------------------
           Opponent zone (top 35%)
        ------------------------------ */
            .opponent-zone {
                flex: 0 0 35%;
                background-color: #F08080; /* light coral */
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }

                .opponent-zone button {
                    padding: 0.75rem 1.5rem;
                    font-size: 1.25rem;
                    cursor: pointer;
                    border: none;
                    border-radius: 4px;
                    background-color: #ffffff;
                    color: #F08080;
                }

                    .opponent-zone button:hover {
                        background-color: #f0f0f0;
                    }

            /* ------------------------------
           Phase tracker strip (10%, min-height: 20px)
        ------------------------------ */
            .phase-zone {
                flex: 0 0 10%;
                min-height: 20px;
                background-color: #EEE8AA; /* pale goldenrod */
                display: flex;
                align-items: center;
                justify-content: center;
            }

                .phase-zone button {
                    padding: 0.5rem 1rem;
                    font-size: 1rem;
                    cursor: pointer;
                    border: none;
                    border-radius: 4px;
                    background-color: #FFFFFF;
                    color: #8B4513; /* saddle brown */
                }

                    .phase-zone button:hover {
                        background-color: #f5f5f5;
                    }

            /* ------------------------------
           Player zone (bottom 55%)
        ------------------------------ */
            .player-zone {
                flex: 0 0 55%;
                display: flex;
                background-color: #B0C4DE; /* light steel blue */
            }
            /* Left column (15% width) */
            .left-zone {
                flex: 0 0 15%;
                background-color: #D3D3D3; /* light gray */
            }
            /* Middle column (70% width) with three equal rows */
            .middle-zone {
                flex: 0 0 70%;
                display: flex;
                flex-direction: column;
            }

                .middle-zone .top {
                    flex: 1;
                    background-color: #90EE90; /* light green */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .middle-zone .center {
                    flex: 1;
                    background-color: #FFFFE0; /* light yellow */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .middle-zone .bottom {
                    flex: 1;
                    background-color: #FFB6C1; /* light pink */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                }

            /* Right column (15% width) with two equal rows */
            .right-zone {
                flex: 0 0 15%;
                display: flex;
                flex-direction: column;
            }
                /* id="deckZone" is on this .top so it fills the entire salmon area */
                .right-zone .top {
                    flex: 1;
                    background-color: #FFA07A; /* light salmon */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                    cursor: pointer; /* entire salmon cell shows pointer */
                }

                .right-zone .bottom {
                    flex: 1;
                    background-color: #87CEFA; /* light sky blue */
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    position: relative;
                }

            /* ------------------------------
           New Inner Zones (centered)
        ------------------------------ */
            .hand-zone {
                width: 80%;
                height: 60%;
                background-color: #FFD700; /* gold */
                display: flex;
                align-items: center;
                justify-content: flex-start;
                flex-wrap: wrap;
                padding: 4px;
                gap: 8px;
                border-radius: 4px;
                color: #000;
            }

            .graveyard-zone {
                width: 80%;
                height: 60%;
                background-color: #2E8B57; /* sea green */
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                border-radius: 4px;
                font-size: 1rem;
            }

            /* Each card “pill” within hand-zone */
            .card-pill {
                background-color: #FFF;
                border: 1px solid #999;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 0.85rem;
                color: #333;
                white-space: nowrap;
                cursor: pointer;
            }

            /* Battlefield zone styling */
            .battlefield-zone {
                width: 80%;
                height: 60%;
                background-color: #ADD8E6; /* light blue */
                display: flex;
                align-items: center;
                justify-content: flex-start;
                flex-wrap: wrap;
                padding: 4px;
                gap: 8px;
                border-radius: 4px;
                color: #000;
                border: 2px dashed #000;
            }
    </style>
</head>

<body>
    <!-- Opponent zone (top, 35% height) -->
    <div class="opponent-zone">
        <button id="startGameBtn">Start Game</button>
    </div>

    <!-- Phase tracker strip (10% height, min-20px) -->
    <div class="phase-zone">
        <button id="nextPhaseBtn">Next Phase</button>
    </div>

    <!-- Player zone (bottom, 55% height) -->
    <div class="player-zone">
        <!-- Left empty column (15%) -->
        <div class="left-zone"></div>

        <!-- Middle column (70%), split into 3 rows -->
        <div class="middle-zone">
            <div class="top">Middle Top</div>
            <div class="center">
                <!-- Battlefield area -->
                <div class="battlefield-zone" id="battlefieldZone">
                    <!-- Played cards will appear here -->
                </div>
            </div>
            <div class="bottom">
                <!-- Hand Zone (centered) -->
                <div class="hand-zone" id="handZone">
                    <!-- Cards get injected here via JS -->
                </div>
            </div>
        </div>

        <!-- Right column (15% width) with two equal rows -->
        <div class="right-zone">
            <!-- id="deckZone" is on this “top” cell so it fills the entire salmon area -->
            <div class="top" id="deckZone">
                <!-- “Deck: N” text will be inserted here -->
            </div>
            <div class="bottom">
                <!-- Graveyard (static for now) -->
                <div class="graveyard-zone">
                    Graveyard
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================
        // Client‐side JavaScript
        // ============================

        let currentGameId = null;

        // ─────────────────────────────────────────────────────────────────
        // 1) Event Delegation on #handZone so any .card-pill (present now
        //    or added later) triggers an alert.
        // ─────────────────────────────────────────────────────────────────
        document.getElementById("handZone").addEventListener("click", function (event) {
            const clickedPill = event.target.closest(".card-pill");
            if (!clickedPill) return;
            const cardName = clickedPill.innerText;
            alert(`You clicked: ${cardName}`);

            // Try to call playCard even if currentGameId is undefined:
            const instanceId = clickedPill.getAttribute("data-instance-id");
            playCard(instanceId);
        });

        // ─────────────────────────────────────────────────────────────────
        // 2) renderHand(cards) – inserts <div class="card-pill">…</div> for each card.
        //    No per-pill listeners needed because of event delegation above.
        // ─────────────────────────────────────────────────────────────────
        function renderHand(cards) {
            const handZone = document.getElementById("handZone");
            handZone.innerHTML = ""; // clear any existing pills

            cards.forEach(card => {
                const pill = document.createElement("div");
                pill.className = "card-pill";
                pill.setAttribute("data-instance-id", card.instanceId);
                pill.innerText = card.name;
                handZone.appendChild(pill);
            });
        }

        // ─────────────────────────────────────────────────────────────────
        // 3) renderBattlefield(cards) – unchanged
        // ─────────────────────────────────────────────────────────────────
        function renderBattlefield(cards) {
            const bfZone = document.getElementById("battlefieldZone");
            bfZone.innerHTML = "";

            cards.forEach(card => {
                const pill = document.createElement("div");
                pill.className = "card-pill";
                pill.innerText = card.name;
                bfZone.appendChild(pill);
            });
        }

        // ─────────────────────────────────────────────────────────────────
        // 4) playCard(cardInstanceId) – we no longer block if currentGameId is null.
        // ─────────────────────────────────────────────────────────────────
        async function playCard(cardInstanceId) {
            console.log("Attempting to play card:", cardInstanceId, "with currentGameId =", currentGameId);
            try {
                const resp = await fetch("/api/game/play", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // send gameId if defined, otherwise omit it entirely
                    body: JSON.stringify(
                        currentGameId
                            ? { gameId: currentGameId, cardInstanceId: cardInstanceId }
                            : { cardInstanceId: cardInstanceId }
                    )
                });
                if (!resp.ok) {
                    console.error("Failed to play card:", resp.status, await resp.text());
                    return;
                }
                const data = await resp.json();
                console.log("/api/game/play response:", data);

                // Re-render hand & battlefield if returned
                if (data.hand) renderHand(data.hand);
                if (data.battlefield) renderBattlefield(data.battlefield);
            } catch (err) {
                console.error("Error calling /api/game/play:", err);
            }
        }

        // ─────────────────────────────────────────────────────────────────
        // 5) “Start Game” button logic
        // ─────────────────────────────────────────────────────────────────
        document.getElementById("startGameBtn").addEventListener("click", async function () {
            console.log("Start Game clicked");
            // Hide “Start Game” so it cannot be clicked again
            this.style.display = "none";

            try {
                const resp = await fetch("/api/game", { method: "POST" });
                if (!resp.ok) {
                    console.error("Failed to start game:", resp.status);
                    return;
                }
                const data = await resp.json();
                console.log("/api/game response:", data);

                // If the response includes gameId or id, store it; otherwise, leave null
                currentGameId = data.gameId ?? data.id ?? null;
                console.log("→ Setting currentGameId =", currentGameId);

                // Show deck count in the salmon cell
                document.getElementById("deckZone").innerText = `Deck: ${data.deckCount}`;

                // Render initial hand
                renderHand(data.hand);

                // Start with an empty battlefield
                renderBattlefield([]);
            } catch (err) {
                console.error("Error calling /api/game:", err);
            }
        });

        // ─────────────────────────────────────────────────────────────────
        // 6) “Next Phase” button (stub)
        // ─────────────────────────────────────────────────────────────────
        document.getElementById("nextPhaseBtn").addEventListener("click", () => {
            console.log("Next Phase clicked (not implemented)");
        });

        // ─────────────────────────────────────────────────────────────────
        // 7) “Draw Card” – now we always send the draw request, regardless of currentGameId.
        // ─────────────────────────────────────────────────────────────────
        document.getElementById("deckZone").addEventListener("click", async () => {
            console.log("Deck clicked; currentGameId =", currentGameId);

            try {
                const resp = await fetch("/api/game/draw", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    // send gameId if defined, otherwise omit it
                    body: JSON.stringify(currentGameId ? { gameId: currentGameId } : {})
                });
                if (!resp.ok) {
                    console.error("Failed to draw card:", resp.status);
                    return;
                }
                const data = await resp.json();
                console.log("/api/game/draw response:", data);

                // Update deck count
                document.getElementById("deckZone").innerText = `Deck: ${data.deckCount}`;

                // If a card was drawn, append it to the hand zone
                if (data.drawnCard !== null) {
                    const handZone = document.getElementById("handZone");
                    const pill = document.createElement("div");
                    pill.className = "card-pill";
                    pill.setAttribute("data-instance-id", data.drawnCard.instanceId);
                    pill.innerText = data.drawnCard.name;
                    handZone.appendChild(pill);
                } else {
                    console.log("No more cards to draw.");
                }
            } catch (err) {
                console.error("Error calling /api/game/draw:", err);
            }
        });
    </script>
</body>
</html>
